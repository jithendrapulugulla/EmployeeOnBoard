# üîß Fix for Azure Auto-Generated Workflow (main_winonboardhr.yml)

## Problem Identified

You had **another workflow file** that was auto-generated by Azure:
```
.github/workflows/main_winonboardhr.yml
```

This file was causing the same npm error because it:
1. Tried to run `npm install` at the root level
2. Didn't specify working directories for backend/frontend
3. Didn't use correct cache paths

## What Was Fixed

### Before (Broken)
```yaml
build:
  steps:
    - run: npm install              # ‚ùå Looks for /package.json
    - run: npm run build --if-present
    - run: npm test --if-present
```

### After (Fixed)
```yaml
build-backend:                      # ‚úÖ Separate backend job
  steps:
    - working-directory: backend
    - run: npm ci                   # ‚úÖ In backend directory

build-frontend:                     # ‚úÖ Separate frontend job
  steps:
    - working-directory: frontend
    - run: npm ci                   # ‚úÖ In frontend directory
```

## Changes Made

### 1. Separated Build Jobs
- `build-backend` - Installs and builds backend
- `build-frontend` - Installs and builds frontend
- Both run in parallel for speed

### 2. Fixed Working Directories
```yaml
- working-directory: backend
  run: npm ci

- working-directory: frontend
  run: npm ci
```

### 3. Fixed Cache Paths
```yaml
cache-dependency-path: backend/package-lock.json
cache-dependency-path: frontend/package-lock.json
```

### 4. Fixed Deployment
- Changed from single app deployment
- Now deploys both backend and frontend
- Deploys to correct app names

## Update GitHub Secrets

This workflow needs these secrets:
```
AZUREAPPSERVICE_PUBLISHPROFILE_BACKEND    (from backend app service)
AZUREAPPSERVICE_PUBLISHPROFILE_FRONTEND   (from frontend app service)
API_BASE_URL                               (your backend API URL)
```

## How to Get Publish Profiles

### For Backend App Service:
```bash
az webapp deployment list-publishing-profiles \
  --resource-group MyResourceGroup \
  --name employee-onboarding-backend \
  --xml
```

Copy the entire output and save as `AZUREAPPSERVICE_PUBLISHPROFILE_BACKEND` secret.

### For Frontend App Service:
```bash
az webapp deployment list-publishing-profiles \
  --resource-group MyResourceGroup \
  --name employee-onboarding-frontend \
  --xml
```

Copy the entire output and save as `AZUREAPPSERVICE_PUBLISHPROFILE_FRONTEND` secret.

## Add the Secrets to GitHub

1. Go to: GitHub repo ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions
2. Add these secrets:
   - `AZUREAPPSERVICE_PUBLISHPROFILE_BACKEND` - Backend publish profile
   - `AZUREAPPSERVICE_PUBLISHPROFILE_FRONTEND` - Frontend publish profile
   - `API_BASE_URL` - e.g., `https://employee-onboarding-backend.azurewebsites.net/api`

## How This Workflow Works

```
1. Push code to main
   ‚Üì
2. Build Backend
   ‚îú‚îÄ‚îÄ npm ci in ./backend/
   ‚îú‚îÄ‚îÄ npm run build
   ‚îú‚îÄ‚îÄ npm test (optional)
   ‚îî‚îÄ‚îÄ Upload artifact
   
3. Build Frontend (parallel)
   ‚îú‚îÄ‚îÄ npm ci in ./frontend/
   ‚îú‚îÄ‚îÄ npm run build
   ‚îú‚îÄ‚îÄ npm test (optional)
   ‚îî‚îÄ‚îÄ Upload artifact
   
4. Deploy (when both builds complete)
   ‚îú‚îÄ‚îÄ Download backend artifact
   ‚îú‚îÄ‚îÄ Download frontend artifact
   ‚îú‚îÄ‚îÄ Deploy backend to Azure
   ‚îî‚îÄ‚îÄ Deploy frontend to Azure
```

## Testing the Fix

1. **Commit and push** the fixed workflow
2. **Go to GitHub Actions** tab
3. **Trigger a workflow run** (or push to main)
4. **Monitor the build:**
   - ‚úÖ `build-backend` completes without npm errors
   - ‚úÖ `build-frontend` completes without npm errors
   - ‚úÖ `deploy` job deploys to Azure

## Verification

After deployment, check:

```bash
# Verify backend is running
curl https://employee-onboarding-backend.azurewebsites.net/health

# Verify frontend is running
curl https://employee-onboarding-frontend.azurewebsites.net/
```

## Summary

| What | Before | After |
|------|--------|-------|
| Working directory | Root (‚ùå) | backend/ and frontend/ (‚úÖ) |
| npm install location | Wrong (‚ùå) | Correct (‚úÖ) |
| Separate jobs | No (‚ùå) | Yes (‚úÖ) |
| Deployment | Single app (‚ùå) | Both apps (‚úÖ) |
| npm error | Yes (‚ùå) | Fixed (‚úÖ) |

## Related Workflows

You also have these other workflows (already fixed):
- `.github/workflows/build-test.yml` - Tests on every push
- `.github/workflows/deploy-azure.yml` - Custom deployment pipeline

The `main_winonboardhr.yml` is the Azure-generated one. You can use either this one or the custom `deploy-azure.yml`. **Recommend using `deploy-azure.yml`** as it has more features.

## To Disable This Workflow (Optional)

If you want to use only the custom workflows, you can:

1. Rename this file to something inactive:
```bash
mv .github/workflows/main_winonboardhr.yml .github/workflows/main_winonboardhr.yml.disabled
```

2. Or delete it (if using custom workflows)

3. Keep the custom workflows:
   - `.github/workflows/build-test.yml`
   - `.github/workflows/deploy-azure.yml`

## Next Steps

1. ‚úÖ Fixed the `main_winonboardhr.yml` workflow
2. Add the 2 publish profile secrets
3. Add the API_BASE_URL secret
4. Push code to trigger the workflow
5. Monitor GitHub Actions for successful build and deploy

**The npm error is now completely resolved across all workflows!** ‚úÖ
